---
title: "SMS Login"
description: "Implement custom SMS provider for user registration and login using Edge Functions"
image: "https://b.ux-cdn.com/uxarts/files/t20251201143554/mm27xz4u.png"
---

# SMS Login

This guide explains how to implement a custom SMS provider for user registration and login in your superun application. The integration uses Supabase Edge Functions to securely handle SMS verification code sending and user registration.

## Overview

This implementation provides a complete SMS-based authentication system that includes:

- SMS verification code generation and sending
- Verification code validation
- User registration with phone number
- Secure storage of verification codes with expiration

## Environment Variables

The `SUPERUN_CLOUD_API_KEY` environment variable is automatically configured when you start superun Cloud. You don't need to manually set this environment variable - it will be available in your Edge Functions once superun Cloud is running.

## Step 1: Create Database Table

First, create the SMS verification code table in your Supabase database.

```sql
-- Create SMS verification code table
CREATE TABLE sms_verifications (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  phone VARCHAR(20) NOT NULL,
  code VARCHAR(6) NOT NULL,
  verified BOOLEAN DEFAULT FALSE,
  expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Create indexes to improve query performance
CREATE INDEX idx_sms_phone ON sms_verifications(phone);
CREATE INDEX idx_sms_expires ON sms_verifications(expires_at);

-- Create index on auth.users phone field for optimized user lookup
-- This index improves performance when querying users by phone number
CREATE INDEX IF NOT EXISTS idx_auth_users_phone ON auth.users(phone);

-- Function to automatically clean up expired verification codes
CREATE OR REPLACE FUNCTION delete_expired_sms_verifications()
RETURNS void AS $$
BEGIN
  DELETE FROM sms_verifications
  WHERE expires_at < NOW() - INTERVAL '1 day';
END;
$$ LANGUAGE plpgsql;
```

## Step 2: Create Send SMS Edge Function

Create an Edge Function to send SMS verification codes (`supabase/functions/send-sms-verification/index.ts`)

```typescript
import { serve } from "https://deno.land/std@0.190.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

// Generate 6-digit random verification code
function generateCode(): string {
  return Math.floor(100000 + Math.random() * 900000).toString();
}

// Send SMS function using superun Gateway
async function sendSMS(
  apiKey: string,
  phone: string,
  code: string,
  countryCode?: string,
) {
  const response = await fetch("https://gateway.superun.ai/sms/send-code", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${apiKey}`,
    },
    body: JSON.stringify({
      countryCode: countryCode || null,
      phone: phone,
      code: code,
    }),
  });

  const result = await response.json();
  
  // Check if SMS was sent successfully
  // Response format: {code, msg, data}
  // Success: code === 0 && data === true
  if (result.code !== 0 || result.data !== true) {
    throw new Error(result.msg || "Failed to send SMS verification code");
  }

  return result;
}

serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response("ok", {
      headers: {
        "Access-Control-Allow-Origin": "*",
        "Access-Control-Allow-Headers":
          "authorization, x-client-info, apikey, content-type",
      },
    });
  }

  // Validate required environment variables
  // SUPERUN_CLOUD_API_KEY is automatically set when superun Cloud is running
  const apiKey = Deno.env.get("SUPERUN_CLOUD_API_KEY");
  if (!apiKey) {
    return new Response(
      JSON.stringify({ error: "SUPERUN_CLOUD_API_KEY is not available. Please ensure superun Cloud is running." }),
      { status: 500, headers: { "Content-Type": "application/json" } }
    );
  }

  try {
    const { phone, countryCode } = await req.json();

    if (!phone) {
      return new Response(
        JSON.stringify({ error: "Phone number is required" }),
        { status: 400, headers: { "Content-Type": "application/json" } }
      );
    }

    // Generate verification code
    const code = generateCode();

    // Send SMS
    await sendSMS(apiKey, phone, code, countryCode);

    // Store verification code in database with expiration
    const supabase = createClient(
      Deno.env.get("SUPABASE_URL") ?? "",
      Deno.env.get("SUPABASE_SERVICE_ROLE_KEY") ?? ""
    );

    const expiresAt = new Date(Date.now() + 5 * 60 * 1000); // Expires in 5 minutes

    await supabase.from("sms_verifications").insert({
      phone: phone,
      code: code,
      expires_at: expiresAt.toISOString(),
      verified: false,
    });

    return new Response(
      JSON.stringify({ success: true, message: "Verification code sent" }),
      {
        status: 200,
        headers: {
          "Content-Type": "application/json",
          "Access-Control-Allow-Origin": "*",
        },
      }
    );
  } catch (error) {
    return new Response(JSON.stringify({ error: error.message }), {
      status: 500,
      headers: { "Content-Type": "application/json" },
    });
  }
});
```

## Step 3: Create Verify and Register Edge Function

Create another Edge Function to verify the code and register/login the user(`supabase/functions/verify-and-register/index.ts`)

This function includes a dedicated `getUserByPhone` method that directly queries the `auth.users` table using `.from()` syntax, just like querying the `sms_verifications` table. The method leverages the indexed phone field for optimized performance. The function automatically:

1. **Checks if user exists**: Queries `auth.users` table by phone number (using index for fast lookup)
2. **Handles existing users**: If user exists, performs login and optionally updates password
3. **Handles new users**: If user doesn't exist, creates a new account with registration

This function supports flexible authentication options:

- **Registration with password**: During registration, users can input both a verification code and a password. After successful registration, they can log in using their phone number and password for future sessions.

- **Verification code login**: Users can also log in directly using only the verification code without entering a password. This provides a passwordless authentication option for convenience.

```typescript
import { serve } from "https://deno.land/std@0.190.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

// Query user by phone number from auth.users table
// Note: phone field has an index for optimized queries
async function getUserByPhone(supabase: any, phone: string) {
  const { data, error } = await supabase
    .schema("auth")
    .from("users")
    .select("id, phone, email, created_at, phone_confirmed_at")
    .eq("phone", phone)
    .maybeSingle();
  
  if (error) {
    throw error;
  }

  return data;
}

serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response("ok", {
      headers: {
        "Access-Control-Allow-Origin": "*",
        "Access-Control-Allow-Headers":
          "authorization, x-client-info, apikey, content-type",
      },
    });
  }

  try {
    const { phone, code, password } = await req.json();

    if (!phone || !code) {
      return new Response(
        JSON.stringify({ error: "Phone number and verification code are required" }),
        { status: 400, headers: { "Content-Type": "application/json" } }
      );
    }

    const supabase = createClient(
      Deno.env.get("SUPABASE_URL") ?? "",
      Deno.env.get("SUPABASE_SERVICE_ROLE_KEY") ?? ""
    );

    // Query verification code
    const { data: verification, error: verifyError } = await supabase
      .from("sms_verifications")
      .select("*")
      .eq("phone", phone)
      .eq("code", code)
      .eq("verified", false)
      .gte("expires_at", new Date().toISOString())
      .order("created_at", { ascending: false })
      .limit(1)
      .single();

    if (verifyError || !verification) {
      return new Response(
        JSON.stringify({ error: "Invalid or expired verification code" }),
        { status: 400, headers: { "Content-Type": "application/json" } }
      );
    }

    // Check if user already exists using phone number (indexed field)
    const existingUser = await getUserByPhone(supabase, phone);
    
    let user;
    let message;

    if (existingUser) {
      // User exists - perform login
      user = existingUser;
      message = "Login successful";
      
      // If password is provided and user wants to update it
      if (password) {
        await supabase.auth.admin.updateUserById(user.id, {
          password: password,
        });
        message = "Login successful, password updated";
      }
    } else {
      // User doesn't exist - create new user (registration)
      // Password is optional - if not provided, user can only login with verification codes
      const createUserOptions: any = {
        phone: phone,
        phone_confirm: true, // Directly confirm phone number
        user_metadata: {
          phone_verified: true,
        },
      };
      
      if (password) {
        createUserOptions.password = password;
      }

      const { data: newUser, error: createError } =
        await supabase.auth.admin.createUser(createUserOptions);
      
      if (createError) {
        return new Response(JSON.stringify({ error: createError.message }), {
          status: 400,
          headers: { "Content-Type": "application/json" },
        });
      }

      user = newUser.user;
      message = "Registration successful";
    }

    // Mark verification code as used
    await supabase
      .from("sms_verifications")
      .update({ verified: true })
      .eq("id", verification.id);

    return new Response(
      JSON.stringify({
        success: true,
        user: user,
        message: message,
        isNewUser: !existingUser,
      }),
      {
        status: 200,
        headers: {
          "Content-Type": "application/json",
          "Access-Control-Allow-Origin": "*",
        },
      }
    );
  } catch (error) {
    return new Response(JSON.stringify({ error: error.message }), {
      status: 500,
      headers: { "Content-Type": "application/json" },
    });
  }
});
```

## Step 4: Frontend Integration

Call the Edge Functions from your frontend application:

```typescript
import { supabase } from "@/integrations/supabase/client";

// Send verification code
async function sendVerificationCode(
  phone: string,
  countryCode?: string
) {
  const { data, error } = await supabase.functions.invoke(
    "send-sms-verification",
    {
      body: { phone, countryCode },
    }
  );

  if (error) {
    throw new Error(error.message);
  }

  return data;
}

// Verify code and register (password is optional)
async function verifyAndRegister(
  phone: string,
  code: string,
  password?: string
) {
  const { data, error } = await supabase.functions.invoke(
    "verify-and-register",
    {
      body: { phone, code, password },
    }
  );

  if (error) {
    throw new Error(error.message);
  }

  return data;
}

// Login with phone number and password (if password was set during registration)
async function loginWithPhone(phone: string, password: string) {
  const { data, error } = await supabase.auth.signInWithPassword({
    phone: phone,
    password: password,
  });

  if (error) {
    throw new Error(error.message);
  }

  return data;
}

// Login with verification code only (passwordless login)
// Note: User should call sendVerificationCode first to receive the code
async function loginWithVerificationCode(phone: string, code: string) {
  // Verify code and login (for existing users) or register (for new users)
  const { data, error } = await supabase.functions.invoke(
    "verify-and-register",
    {
      body: { phone, code }, // No password for passwordless login
    }
  );

  if (error) {
    throw new Error(error.message);
  }

  return data;
}
```

After successful registration, users have two login options:

1. **Password login** (if password was set during registration):

```typescript
// Example: Login with password
await supabase.auth.signInWithPassword({
  phone: phone,
  password: password,
});
```

2. **Verification code login** (passwordless):

```typescript
// Example: Login with verification code only
await loginWithVerificationCode(phone, code);
```

## Customization

### SMS API Parameters

The `sendSMS` function uses the superun Gateway API with the following parameters:

- `countryCode` (optional): Country code for international phone numbers
- `phone` (required): Phone number to send verification code to
- `code` (required): The 6-digit verification code

### Verification Code Expiration

The default expiration time is 5 minutes. You can adjust this in the `send-sms-verification` function:

```typescript
const expiresAt = new Date(Date.now() + 10 * 60 * 1000); // 10 minutes
```

### Rate Limiting

Consider implementing rate limiting to prevent abuse:

- Limit the number of SMS requests per phone number per hour
- Add IP-based rate limiting
- Implement CAPTCHA for additional security

## Security Considerations

- Always use Edge Functions to handle SMS operations
- Never expose API keys in client-side code
- Validate phone numbers on both client and server
- Implement proper error handling
- Use HTTPS for all API calls
- Regularly clean up expired verification codes
- Monitor for suspicious activity
